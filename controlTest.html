<html>
	<head>
		<title>Where Am I?</title>
		<style>canvas { width: 100%; height: 100% }</style>
	</head>
	<body>
		<script src="https://rawgithub.com/mrdoob/three.js/master/build/three.js"></script>
		<script src="colors.js"></script>
		<script src="room.js"></script>
		<script src="path.js"></script>
		<script src="worldgen.js"></script>
		<script src="control.js"></script>
		<script src="optimer_bold.typeface.js"></script>
		<script>
			//Start with 3 parts, scene, camera and renderer
			var scene = new THREE.Scene();

			//<FOV>, <ASPECTRATIO>, <NEARCLIP>, <FARCLIP>
			var camera = new THREE.PerspectiveCamera( 80, window.innerWidth / window.innerHeight, 0.1, 40 );
			camera.rotation = new THREE.Euler( 0, 0, 0, 'YXZ' );

			var renderer = new THREE.WebGLRenderer({ antialias: true });

			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			var holding = null;

			// var directionalLight = new THREE.DirectionalLight( 0xffffff , 10);
			// directionalLight.position.set( 1, 1, 1 ).normalize();
			// scene.add(directionalLight);



			//var rooms = gen_test_6_2();
			
			var rooms;
			var theRoom;

			var angle;

			camera.position.x = 0;
			camera.position.y = 2.6;
			camera.position.z = 0;

			var wIsPressed;
			var sIsPressed;
			var aIsPressed;
			var dIsPressed;
			var lShiftIsPressed;
			var spaceIsPressed;

			var HOLDING_Z_OFFSET = 1;

			var mouseX;
			var mouseY;

			var dVert;
			var theta;
			var dTheta;
			var mouseXOld;
			var mouseYOld;
			runGen(gen_menu);

			

			function attemptGrab() {
				if(holding == null) {
					holding = theRoom.object;
					theRoom.object = null;
					theRoom.clearCopies(scene);
					holding.scale = new THREE.Vector3(.7, .7, .7);
				}
				else if(theRoom.object == null) {
					holding = theRoom.placeBlock(scene, holding);
					isGameSolved();
				}
				else {
					holding = theRoom.placeBlock(scene, holding);
					holding.scale = new THREE.Vector3(.7, .7, .7);
				}
			}

			

			function updateCamera() {
				if(wIsPressed == true) {
					camera.position.x += Math.cos( (Math.PI / 2) + camera.rotation.y) / 5;
	                camera.position.z -= Math.sin( (Math.PI / 2) + camera.rotation.y) / 5;
	               	if(holding != null) {
	               		holding.position.x += Math.cos( (Math.PI / 2) + camera.rotation.y) / 5;
	               		holding.position.z -= Math.sin( (Math.PI / 2) + camera.rotation.y) / 5;
	               	}
				}
				if(sIsPressed == true) {
                	camera.position.x += Math.cos( (-Math.PI / 2) + camera.rotation.y) / 5;
                	camera.position.z -= Math.sin( (-Math.PI / 2) + camera.rotation.y) / 5;
				}
				if(aIsPressed == true) {
					camera.position.x -= Math.cos(camera.rotation.y) / 10;
	                camera.position.z += Math.sin(camera.rotation.y) / 10;
				}
				if(dIsPressed == true) {
	                camera.position.x += Math.cos(camera.rotation.y) / 10;
                	camera.position.z -= Math.sin(camera.rotation.y) / 10;
				}
				// if(lShiftIsPressed == true) {
				// 	camera.position.y -= dVert;
				// }
				// if(spaceIsPressed == true) {
				// 	camera.position.y += dVert;
				// }

				var oldAngle = angle;
				if(camera.position.x > ROOM_OFFSET - ROOM_TOLERANCE) {
					if(camera.position.z > -DOOR_OFFSET + ROOM_TOLERANCE 
						&& camera.position.z < DOOR_OFFSET - ROOM_TOLERANCE
						&& rebuild(3) ) {
							if((menu)) {
								menu = false;
								runGen(gen_3);
							} else {
								camera.position.x = -ROOM_OFFSET + ROOM_TOLERANCE;
							}
					} else {
						camera.position.x = ROOM_OFFSET - ROOM_TOLERANCE;
					}
				}
				if(camera.position.x < -ROOM_OFFSET + ROOM_TOLERANCE) {
					if(camera.position.z > -DOOR_OFFSET + ROOM_TOLERANCE 
						&& camera.position.z < DOOR_OFFSET - ROOM_TOLERANCE
						&& rebuild(1) ) {
							if(menu) {
								menu = false;
								runGen(gen_1);
							} else {
								camera.position.x = ROOM_OFFSET - ROOM_TOLERANCE;
							}
					} else {
						camera.position.x = -ROOM_OFFSET + ROOM_TOLERANCE;
					}
				}
				if(camera.position.z > ROOM_OFFSET - ROOM_TOLERANCE) {
					if(camera.position.x > -DOOR_OFFSET + ROOM_TOLERANCE 
						&& camera.position.x < DOOR_OFFSET - ROOM_TOLERANCE
						&& rebuild(2) ) {
							menu = false;
							camera.position.z = -ROOM_OFFSET + ROOM_TOLERANCE;
					} else {
						camera.position.z = ROOM_OFFSET - ROOM_TOLERANCE;
					}
				}
				if(camera.position.z < -ROOM_OFFSET + ROOM_TOLERANCE) {
					if(camera.position.x > -DOOR_OFFSET + ROOM_TOLERANCE
						&& camera.position.x < DOOR_OFFSET - ROOM_TOLERANCE
						&& rebuild(0) ) {
							if((menu)  && oldAngle == 2) {
								menu = false;
								runGen(gen_2);
							} else {
								camera.position.z = ROOM_OFFSET - ROOM_TOLERANCE;
							}
					} else {					
						camera.position.z = -ROOM_OFFSET + ROOM_TOLERANCE;
					}
				}

				if(mouseDown) {
					camera.rotation.y -= (mouseX - mouseXOld) / 300;
					camera.rotation.x -= (mouseY - mouseYOld) / 600;
				}
				
				if(holding != null) {
					holding.position.y = 1.5;
					holding.position.x = camera.position.x - Math.sin(camera.rotation.y - Math.PI/4);
					holding.position.z = camera.position.z - Math.cos(camera.rotation.y - Math.PI/4);
					holding.rotation.y = camera.rotation.y;
				}

				mouseXOld = mouseX;
				mouseYOld = mouseY; 
				
			}

			function render() {
				requestAnimationFrame(render);

				updateCamera();
				//console.log("x: " + camera.position.x + "   z: " + camera.position.z);
				renderer.render(scene, camera);
			}
			
			render();

			function rebuild(side) {
				var path = theRoom.paths[(side - angle + 4) % 4];
				if(path != null) {
					theRoom = path.to_room;
				} else {
					return false;
				}

				//nuke
				while(scene.children.length > 0) {
					var child = scene.children[scene.children.length - 1];
					scene.remove(child);
					//renderer.deallocateObject(child);
				}

				for (var c = 0; c < rooms.length; c++) {
					rooms[c].resetCounts();
				}

				if(holding != null)
					scene.add(holding);

				console.log("old angle: " + angle);

				angle = 2 + side - path.to_door;
				console.log("new angle: " + angle);
				console.log("side: " + side);
				theRoom.buildFirsthand(scene, angle);

				return true;
			}

			function isGameSolved() {
				for (var c = 0; c < rooms.length; c++) {
					if (rooms[c].object == null || rooms[c].object.material != rooms[c].materials[0])
						return false;
				}
				alert("YOU WON!!!!");
				menu = true;
				runGen(gen_menu);
			}

			function runGen(generate) {
				rooms = generate();

				theRoom = rooms[0];

				angle = 0;
				theRoom.buildFirsthand(scene, angle);

				camera.position.x = 0;
				camera.position.y = 2.6;
				camera.position.z = 0;
				//camera.lookAt(5,2.6,5);

				radius = 10;

				wIsPressed = false;
				sIsPressed = false; 
				aIsPressed = false;
				dIsPressed = false;
				lShiftIsPressed = false;
				spaceIsPressed = false;

				HOLDING_Z_OFFSET = 1;

				var dVert = .1;
			}

			document.onkeydown = function(down) {

				switch (down.keyCode) {
	                case 87: // W
	                	wIsPressed = true;
	                break;

	                case 83: // S
	                	sIsPressed = true;
	                break;

	                case 65: // A
	                	aIsPressed = true;
	                break;

	                case 68: // D
	     				dIsPressed = true;
	                break;

	                case 69: //E
	                	attemptGrab();
	                break;

	                case 32: // Space
	                	spaceIsPressed = true;
	                break;

	                case 16: // lShift
	                	lShiftIsPressed = true;
	                break;

	                case 66:
	                	alert(mouseX);
	                break;
				}
			}

			document.onkeyup = function(up) {

				switch (up.keyCode) {
	                case 87: // W
	                	wIsPressed = false;
	                break;

	                case 83: // S
	                	sIsPressed = false;
	                break;

	                case 65: // A
	                	aIsPressed = false;
	                break;

	                case 68: // D
	     				dIsPressed = false;
	                break;

	                case 32: // Space
	                	spaceIsPressed = false;
	                break;
	                
	                case 16: // lShift
	                	lShiftIsPressed = false;
	                break;	                

	                case 66:
	                	alert(mouseX);
	                break;
				}
			}
			

			document.onmousemove = function(move) {
				mouseX = move.clientX;
				mouseY = move.clientY;
			}

			var mouseDown;
			document.onmousedown = function(click) {
				mouseDown = true;
			}

			document.onmouseup = function(release) {
				mouseDown = false;
			}
			

			
		</script>
	</body>
</html>